# Архитектура проекта Appium JS Tests

Подробное описание структуры и назначения каждого компонента проекта мобильных автотестов.

## Обзор проекта

Проект представляет собой полнофункциональную систему мобильного автотестирования с использованием:

- **WebDriverIO** - тестовый фреймворк и WebDriver клиент
- **Appium** - сервер автоматизации мобильных приложений
- **Allure** - система генерации отчетов
- **TypeScript** - типизированный JavaScript
- **Recovery System** - система восстановления после сбоев
- **Enhanced Debug** - расширенная система отладки

---

## Корневые файлы

### `wdio.conf.ts`

**Назначение**: Основной конфигурационный файл WebDriverIO
**Что делает**:

- Настройка capabilities для Android устройств/эмуляторов
- Конфигурация Appium подключения (host, port)
- Настройка репортеров (Allure, Spec)
- Хуки жизненного цикла тестов (beforeTest, afterTest, beforeSession, afterSession)
- Система сбора артефактов (скриншоты, видео, логи)
- Интеграция Enhanced Debug системы
- Система восстановления после падений тестов
- Управление установкой/удалением приложения

### `tsconfig.json`

**Назначение**: Конфигурация TypeScript компилятора
**Что делает**:

- Настройка путей и алиасов
- Конфигурация типов и модулей
- Настройка совместимости с WebDriverIO и Node.js

### `package.json`

**Назначение**: Метаданные проекта и зависимости
**Что делает**:

- Определение npm скриптов (test:local, test:ci, allure:\*)
- Управление зависимостями (WebDriverIO, Appium, Allure)
- Настройка типов TypeScript

---

## Директория `/src`

### `/src/Pages` - Page Object Model

#### `BasePage.ts`

**Назначение**: Базовый класс для всех Page Objects
**Что делает**:

- Общие методы для работы с элементами
- Базовые ожидания и проверки
- Общие селекторы и утилиты
- Методы для работы с экраном (скроллинг, ожидание загрузки)

#### `LoginPage.ts`

**Назначение**: Page Object для экрана входа/онбординга
**Что делает**:

- Методы авторизации (логин, регистрация)
- Обработка онбординга и кнопки "Начать"
- Множественные стратегии поиска элементов (XPath, accessibility, text)
- Ожидание активации элементов с увеличенными таймаутами
- Альтернативные методы взаимодействия (координаты при недоступности элементов)

#### `DashboardPage.ts`

**Назначение**: Page Object для главного экрана приложения
**Что делает**:

- Проверка элементов дашборда
- Взаимодействие с основным функционалом
- Навигация по разделам приложения

### `/src/helpers` - Вспомогательные утилиты

#### `/src/helpers/prepare/prepareApp.ts`

**Назначение**: Подготовка приложения к тестированию
**Что делает**:

- Инициализация приложения перед тестами
- Обработка онбординга (условная логика - только при первом запуске или после падений)
- Настройка тестового окружения
- Интеграция с системой восстановления
- Ожидание стабилизации приложения после recovery

#### `/src/helpers/prepare/scroll.ts`

**Назначение**: Утилиты для скроллинга
**Что делает**:

- Различные стратегии скроллинга
- Поиск элементов через скроллинг
- Обработка длинных списков

#### `/src/helpers/email/EmailHelper.ts`

**Назначение**: Работа с email (вероятно для получения кодов подтверждения)
**Что делает**:

- Подключение к email сервисам
- Получение и парсинг писем
- Извлечение кодов подтверждения

#### `/src/helpers/data/TestDataManager.ts`

**Назначение**: Управление тестовыми данными
**Что делает**:

- Загрузка и сохранение тестовых данных
- Генерация тестовых пользователей
- Управление состоянием данных между тестами

#### `/src/helpers/data/testMeta.ts`

**Назначение**: Метаданные тестов
**Что делает**:

- Хранение информации о тестах
- Теги и категории тестов
- Приоритеты и зависимости

### `/src/utils` - Системные утилиты

#### `appState.ts`

**Назначение**: Управление состоянием приложения
**Что делает**:

- Отслеживание завершения онбординга
- Сохранение состояния между тестами
- Флаги готовности компонентов приложения
- Интеграция с системой восстановления

#### `testRecovery.ts`

**Назначение**: Система восстановления после падений тестов
**Что делает**:

- Отслеживание статуса предыдущих тестов
- Стратегии восстановления (restart, clear-data, reinstall)
- Логика принятия решений о типе восстановления
- Сброс состояния приложения после recovery
- Логирование процесса восстановления

#### `traceEnhancer.ts` ⭐

**Назначение**: Расширенная система отладки для упавших тестов
**Что делает**:

- **Автоматическое определение активного устройства** (решает проблему "more than one device")
- **Сбор UI Hierarchy** - полная структура экрана в XML формате
- **Системная информация** - модель устройства, версия Android, батарея, память
- **Контекст приложения** - текущая activity, package, состояние сети
- **Фильтрованные логи** - только релевантные логи приложения (com.fin.whiteswan, ReactNativeJS, FATAL)
- **Метрики производительности** - использование памяти приложением
- **Параллельный сбор** - все данные собираются одновременно для скорости
- **Форматирование отчетов** - читаемый вывод с индикаторами статуса

#### `steps.ts`

**Назначение**: Низкоуровневые утилиты для шагов
**Что делает**:

- Базовая интеграция с Allure
- Обертка над startStep/endStep
- Обработка ошибок в шагах

#### `stepHelper.ts`

**Назначение**: Высокоуровневые утилиты для бизнес-шагов
**Что делает**:

- Функция `stepSS` с автонумерацией
- Встроенные скриншоты в шаги
- Управление счетчиком шагов
- Конфигурация отображения шагов

#### `reportUtils.ts`

**Назначение**: Утилиты для работы с отчетами
**Что делает**:

- Форматирование данных для Allure
- Вложения и артефакты
- Метаданные отчетов

#### `clean-allure.ts`

**Назначение**: Очистка директорий Allure
**Что делает**:

- Удаление старых результатов
- Подготовка к новому прогону
- Управление дисковым пространством

### `/src/json-data` - Тестовые данные

#### `test-data.json`

**Назначение**: Основные тестовые данные
**Что делает**:

- Пользователи для тестирования
- Тестовые суммы и операции
- Конфигурационные данные

#### `test-data-backup.json`

**Назначение**: Резервная копия тестовых данных
**Что делает**:

- Восстановление после повреждения основного файла
- Откат к стабильному состоянию

### `/src/apps` - APK файлы

#### `build-*.apk`

**Назначение**: Файлы приложения для тестирования
**Что делает**:

- Автоматический поиск наиболее нового билда
- Установка на устройство/эмулятор
- Версионирование билдов

---

## Директория `/tests`

#### `first-test.ts`

**Назначение**: Основной файл с тестами
**Что делает**:

- **Регистрация пользователей** - создание новых аккаунтов
- **Авторизация** - вход в существующие аккаунты
- **Финансовые операции** - добавление доходов и расходов
- **Проверка баланса** - валидация корректности расчетов
- **Интеграция с prepareApp** - инициализация приложения перед каждым тестом
- **Использование Page Objects** - структурированное взаимодействие с UI
- **Бизнес-шаги** - использование stepSS для читаемых отчетов

---

## Директории результатов

### `/allure-results`

**Назначение**: Сырые результаты тестов
**Что содержит**:

- JSON файлы с результатами тестов
- Вложения (скриншоты, видео, логи, UI Hierarchy)
- Метаданные тестов
- Environment properties

### `/allure-report`

**Назначение**: Сгенерированный HTML отчет
**Что содержит**:

- Веб-интерфейс с результатами
- Графики и статистика
- Детальная информация по тестам
- Вложения для анализа багов

---

## Workflow выполнения тестов

### 1. Инициализация (beforeSession)

- Определение устройства (эмулятор/реальное)
- Поиск и установка APK
- Запуск Appium сессии
- Настройка capabilities

### 2. Подготовка теста (beforeTest)

- **Recovery проверка** - анализ статуса предыдущего теста
- **Выполнение восстановления** - если предыдущий тест упал (restart/clear-data/reinstall)
- Очистка logcat (опционально)
- Запуск записи экрана

### 3. Выполнение теста

- **prepareApp()** - инициализация и обработка онбординга (условно)
- **Бизнес-логика теста** - основные действия через Page Objects
- **stepSS()** - структурированные шаги с автонумерацией и скриншотами

### 4. Обработка результата (afterTest)

- **Скриншот при ошибке** (всегда для failed тестов)
- **Enhanced Debug Info** (если ENHANCED_DEBUG=true):
  - UI Hierarchy (XML дамп экрана)
  - Системная информация (устройство, Android, память, батарея)
  - Отфильтрованные логи приложения
  - Метрики производительности
- **Видео** (screen recording)
- **logcat и meminfo** (системные логи)
- **Маркировка статуса теста** для Recovery системы

### 5. Завершение (afterSession)

- Остановка записи экрана
- Удаление приложения (если KEEP_APP=false)
- Закрытие WebDriver сессии

### 6. Финальная очистка (onComplete)

- Принудительное удаление приложения (adb uninstall)
- Генерация Allure отчета
- Очистка временных файлов

---

## Ключевые особенности архитектуры

### 🔄 Система восстановления (Recovery System)

- **Автоматическое восстановление** после падений тестов
- **Три стратегии**: restart (быстро), clear-data (чисто), reinstall (полностью)
- **Сохранение контекста** между тестами
- **Логирование процесса** для отладки

### 🔍 Enhanced Debug System

- **Автоматический сбор** отладочной информации только для упавших тестов
- **Решение проблем с устройствами** - автоматическое определение активного устройства
- **Параллельный сбор** для скорости
- **Структурированные отчеты** с понятными статусами

### 📱 Page Object Model

- **Инкапсуляция логики** работы с экранами
- **Множественные стратегии** поиска элементов
- **Устойчивость к изменениям** UI
- **Переиспользуемые компоненты**

### 📊 Система отчетности

- **Allure интеграция** с богатыми отчетами
- **Автонумерация шагов** для структурированности
- **Встроенные скриншоты** в шаги
- **Артефакты для отладки** (видео, логи, UI dumps)

### ⚙️ Конфигурируемость

- **Переменные окружения** для управления поведением
- **Стратегии выполнения** (CI/локальное)
- **Гибкие настройки** сбора артефактов
- **Масштабируемость** под разные проекты

---

## Зависимости и интеграции

### Внешние зависимости

- **WebDriverIO** - основа тестового фреймворка
- **Appium** - мобильная автоматизация
- **Allure** - система отчетов
- **TypeScript** - типизация
- **Android SDK/ADB** - работа с устройствами

### Внутренние зависимости

- **testRecovery ↔ appState** - управление состоянием
- **prepareApp ↔ LoginPage** - инициализация и онбординг
- **traceEnhancer ↔ wdio.conf.ts** - сбор отладочной информации
- **stepHelper ↔ reportUtils** - формирование отчетов
- **Page Objects ↔ tests** - структурированное тестирование

Эта архитектура обеспечивает стабильные, информативные и легко поддерживаемые мобильные автотесты с развитой системой диагностики и восстановления.
